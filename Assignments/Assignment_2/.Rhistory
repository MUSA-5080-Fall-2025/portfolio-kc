kbl(
caption = "Table 1. Summary Statistics of School Safety and Bicycle Infrastructure in Philadelphia",
align = c('c', 'c', 'c'),
booktabs = TRUE
) %>%
kable_styling(
full_width = FALSE,
bootstrap_options = c("striped", "hover", "condensed", "responsive")
)
# Drop geometry and clean data
at_risk_table <- at_risk_schools %>%
st_drop_geometry() %>%
filter(!is.na(school_name_label)) %>%
select(
`School Name` = school_name_label,
`Crime Incidents` = crime_count,
`Nearby Bike Lane` = has_bike
) %>%
mutate(
`Crime Incidents` = formatC(`Crime Incidents`, format = "d", big.mark = ","),
`Nearby Bike Lane` = if_else(`Nearby Bike Lane` == 1, "Yes", "No")
) %>%
arrange(desc(as.numeric(`Crime Incidents`))) %>%
slice_head(n = 10)
# Output table
at_risk_table %>%
kbl(
caption = "Table 2. Top 10 At-Risk Schools in Philadelphia: High Crime and No Nearby Bicycle Infrastructure",
align = c("l", "c", "c"),
booktabs = TRUE
) %>%
kable_styling(
full_width = FALSE,
bootstrap_options = c("striped", "hover", "condensed", "responsive")
) %>%
column_spec(1, bold = TRUE, width = "5cm") %>%
column_spec(2:3, width = "3cm") %>%
add_header_above(c(" " = 1, "Safety Risk Indicators" = 2))
# Create 500 ft buffers around schools
school_buffer <- st_buffer(schools, dist = 500)
# Create 300 ft buffers around bike lanes
bike_buffer <- st_buffer(bike_network, dist = 300)
# Quick visualization
library(tmap)
tmap_mode("plot")
tm_shape(crime) +
tm_density(
col = "Reds",        # 色带（可换 "Oranges", "Purples", "YlOrRd" 等）
style = "cont",      # 连续渐变色
alpha = 0.6,         # 透明度
title = "Crime Density"
) +
tm_shape(bike_network) +
tm_lines(col = "steelblue", lwd = 1, alpha = 0.8) +
tm_shape(schools) +
tm_dots(col = "black", size = 0.05) +
tm_layout(
title = "Crime Density Heatmap with Schools and Bike Network",
frame = FALSE,
legend.outside = TRUE
)
# Create 500 ft buffers around schools
school_buffer <- st_buffer(schools, dist = 500)
# Create 300 ft buffers around bike lanes
bike_buffer <- st_buffer(bike_network, dist = 300)
# Quick visualization
library(ggplot2)
ggplot() +
stat_density_2d(
data = st_coordinates(crime) |> as.data.frame(),
aes(X, Y, fill = after_stat(level)),
geom = "polygon",
alpha = 0.6
) +
geom_sf(data = bike_network, color = "steelblue", size = 0.3) +
geom_sf(data = schools, color = "black", size = 0.5) +
scale_fill_viridis_c(option = "magma") +
labs(
title = "Crime Density Heatmap with Schools and Bike Network",
fill = "Density"
) +
theme_minimal()
# Create 500 ft buffers around schools
school_buffer <- st_buffer(schools, dist = 500)
# Create 300 ft buffers around bike lanes
bike_buffer <- st_buffer(bike_network, dist = 300)
# Quick visualization
library(ggplot2)
library(sf)
# 将点坐标提取为数据框
crime_coords <- st_coordinates(crime) |> as.data.frame()
colnames(crime_coords) <- c("X", "Y")
# 绘制改良版静态热力图
ggplot() +
stat_density_2d(
data = crime_coords,
aes(x = X, y = Y, fill = after_stat(density)),
geom = "raster",
contour = FALSE,
alpha = 0.7
) +
scale_fill_viridis_c(option = "magma", name = "Crime Density") +
geom_sf(data = bike_network, color = "steelblue", size = 0.3) +
geom_sf(data = schools, color = "black", size = 0.6) +
labs(
title = "Crime Density Heatmap with Schools and Bike Network",
subtitle = "Areas with higher color intensity represent higher crime density",
x = "Longitude", y = "Latitude"
) +
theme_minimal()
# Create 500 ft buffers around schools
school_buffer <- st_buffer(schools, dist = 500)
# Create 300 ft buffers around bike lanes
bike_buffer <- st_buffer(bike_network, dist = 300)
# Quick visualization
library(tmap)
tmap_mode("plot")
tm_shape(bike_buffer) +
tm_borders(col = "steelblue", lwd = 1) +
tm_shape(school_buffer) +
tm_borders(col = "red", lwd = 1) +
tm_shape(crime) +
tm_dots(col = "black", size = 0.02) +
tm_layout(
title = "School and Bike Lane Buffers with Crime Points",
frame = FALSE,
legend.outside = TRUE
)
# Load required packages
library(sf)
library(tidycensus)
library(tigris)
library(dplyr)
library(ggplot2)
library(units)
library(stringr)
library(knitr)
library(scales)
library(readr)
library(kableExtra)
# Load spatial data
pa_counties=st_read("/Users/cathy/GitHub/MUSA-5080-Fall-2025/lectures/week-04/data/Pennsylvania_County_Boundaries.shp")
pa_hospital=st_read("/Users/cathy/GitHub/MUSA-5080-Fall-2025/lectures/week-04/data/hospitals.geojson")
census_tracts <- tracts(state="PA", cb=TRUE)
# Check that all data loaded correctly
head(pa_counties)
head(pa_hospital)
head(census_tracts)
cat("CRS summary — Counties:", st_crs(pa_counties)$input,
"; Hospitals:", st_crs(pa_hospital)$input,
"; Tracts:", st_crs(census_tracts)$input, "\n")
# Get demographic data from ACS
data=c(over65="DP05_0024",income="DP03_0062",population="DP02_0018")
d1=get_acs(
state = "PA",
geography = "tract",
year = 2023,
survey = "acs5",
variables = data,
geometry = TRUE,
output="wide"
)
# Join to tract boundaries
d1 <- left_join(census_tracts, st_drop_geometry(d1), by = "GEOID")
head(d1)
st_geometry_type(d1)
# Check for missing income values
sum(is.na(d1$incomeE))
# Calculate the median income across all tracts
median_income <- median(d1$incomeE, na.rm = TRUE)
median_income
# Filter for vulnerable tracts based on your criteria
summary(d1)
vulnerable=d1%>%
filter(over65E>945|incomeE<32150
)
num_vulnerable <- nrow(vulnerable)
total_tracts <- nrow(d1)
percent_vulnerable <- round((num_vulnerable / total_tracts) * 100, 1)
cat("Low income threshold: $32,150\n")
cat("Elderly population threshold: 945 people\n")
cat("Number of vulnerable tracts:", num_vulnerable, "\n")
cat("Total tracts:", total_tracts, "\n")
cat("Percentage of vulnerable tracts:", percent_vulnerable, "%\n")
# Transform to appropriate projected CRS
proj_crs <- 3365
vulnerable_proj <- vulnerable %>%
st_transform(proj_crs)
hosp_proj <- pa_hospital %>%
st_transform(proj_crs)
vulner_centroid <- st_centroid(vulnerable_proj)
dist <- vulner_centroid %>%
mutate(
dist_meters = apply(st_distance(vulner_centroid, hosp_proj), 1, min),
dist_miles = dist_meters * 0.000621371
)
avg_dist <- mean(dist$dist_miles, na.rm = TRUE)
max_dist <- max(dist$dist_miles, na.rm = TRUE)
num_over15 <- sum(dist$dist_miles > 15)
cat("Average distance to nearest hospital (miles):", round(avg_dist, 2), "\n")
cat("Maximum distance (miles):", round(max_dist, 2), "\n")
cat("Number of vulnerable tracts >15 miles from a hospital:", num_over15, "\n")
#### Step 5: Identify Underserved Areas
underserved <- dist %>%
mutate(underserved = ifelse(dist_miles > 15, TRUE, FALSE))
num_underserved <- sum(underserved$underserved, na.rm = TRUE)
total_vulnerable <- nrow(underserved)
perc_underserved <- round((num_underserved / total_vulnerable) * 100, 1)
cat("Number of underserved tracts:", num_underserved, "\n")
cat("Percentage of vulnerable tracts that are underserved:", perc_underserved, "%\n")
pa_counties_proj <- st_transform(pa_counties, st_crs(underserved))
tracts_with_county <- st_join(underserved, pa_counties_proj, join = st_intersects, left = FALSE)
st_crs(underserved)$input
st_crs(pa_counties_proj)$input
tracts_with_county <- st_join(underserved, pa_counties_proj, join = st_intersects, left = FALSE)
names(pa_counties)
county_summary <- tracts_with_county %>%
st_drop_geometry() %>%
group_by(COUNTY_NAM) %>%
summarise(
vulnerable_tracts = n(),
underserved_tracts = sum(underserved, na.rm = TRUE),
perc_underserved = round((underserved_tracts / vulnerable_tracts) * 100, 1),
avg_distance_miles = round(mean(dist_miles, na.rm = TRUE), 2),
total_vulnerable_pop = sum(populationE, na.rm = TRUE)
) %>%
arrange(desc(perc_underserved))
head(county_summary, 10)
# Create and format priority counties table
priority_counties <- county_summary %>%
arrange(desc(perc_underserved), desc(avg_distance_miles)) %>%
slice_head(n = 10) %>%
mutate(
perc_underserved = paste0(perc_underserved, "%"),
avg_distance_miles = round(avg_distance_miles, 2),
total_vulnerable_pop = formatC(total_vulnerable_pop, format = "d", big.mark = ",")
)
library(kableExtra)
kable(
priority_counties,
col.names = c("County", "Vulnerable Tracts", "Underserved Tracts", "% Underserved",
"Avg Distance (miles)", "Total Vulnerable Population"),
caption = "Table 1. Top 10 Pennsylvania Counties with the Greatest Need for Healthcare Investment",
align = "c"
) %>%
kable_styling(
bootstrap_options = c("striped", "hover", "condensed", "responsive"),
full_width = FALSE,
position = "center",
font_size = 13
) %>%
row_spec(0, bold = TRUE, background = "darkgrey", color = "white") %>%
row_spec(1:10, background = "#f8f9fa") %>%
add_header_above(c(" " = 1, "Tract Counts" = 2, "Accessibility & Population" = 3))
library(sf)
library(tidyverse)
library(tmap)
library(knitr)
tmap_mode("plot")
tm_shape(pa_counties_proj %>%
left_join(county_summary, by = c("COUNTY_NAM" = "COUNTY_NAM"))) +
tm_polygons(
col = "avg_distance_miles",
palette = "Blues",
style = "quantile",
n = 5,
title = "Avg. Distance to Hospital (miles)"
) +
tm_borders(col = "gray50", lwd = 0.5) +
tm_layout(
legend.outside = TRUE,
frame = FALSE,
bg.color = "white"
)
library(ggplot2)
library(dplyr)
library(sf)
county_map <- pa_counties %>%
st_transform(3365) %>%
left_join(county_summary, by = c("COUNTY_NAM" = "COUNTY_NAM"))
hospital_points <- pa_hospital %>%
st_transform(3365)
ggplot() +
geom_sf(data = county_map, aes(fill = perc_underserved), color = "white", size = 0.3) +
geom_sf(data = hospital_points, color = "pink", size = 1, alpha = 0.7) +
scale_fill_gradient(
name = "% Underserved\nVulnerable Tracts",
low = "lightgrey", high = "black",
labels = function(x) paste0(x, "%")
) +
labs(
title = "Healthcare Accessibility Across Pennsylvania Counties",
subtitle = "Percentage of vulnerable tracts underserved and hospital locations",
caption = "Data source: 2023 ACS 5-Year Estimates & Pennsylvania Department of Health"
) +
theme_void() +
theme(
plot.title = element_text(size = 16, face = "bold"),
plot.subtitle = element_text(size = 12, margin = margin(b = 10)),
plot.caption = element_text(size = 9, color = "gray40"),
legend.title = element_text(size = 10, face = "bold"),
legend.text = element_text(size = 9),
legend.position = "right"
)
# Create a clean dataframe of distances
dist_df <- dist %>%
st_drop_geometry() %>%
select(dist_miles)
ggplot(dist_df, aes(x = dist_miles)) +
geom_histogram(
bins = 30,
fill = "lightpink",
color = "white",
alpha = 0.8
) +
labs(
title = "Distribution of Distances to the Nearest Hospital (Vulnerable Tracts)",
x = "Distance to Nearest Hospital (miles)",
y = "Number of Vulnerable Census Tracts",
caption = "Most vulnerable tracts are within 15 miles of a hospital, but a right tail shows rural access challenges."
) +
theme_minimal(base_size = 13) +
theme(
plot.title = element_text(size = 15, face = "bold"),
axis.title = element_text(face = "bold"),
plot.caption = element_text(size = 10, color = "gray40")
)
# Load your additional dataset
library(sf)
library(tidyverse)
library(tmap)
schools <- st_read("/Users/cathy/GitHub/portfolio-setup-uxiaoo22/Assignments/Assignment_2/Schools.geojson")
crime <- st_read("/Users/cathy/GitHub/portfolio-setup-uxiaoo22/Assignments/Assignment_2/incidents_part1_part2/incidents_part1_part2.shp")
bike_network <- st_read("/Users/cathy/GitHub/portfolio-setup-uxiaoo22/Assignments/Assignment_2/PhiladelphiaBikeNetwork_SupportingDatasets201209/BikeNetwork_SupportingDatasets201209/PhiladelphiaBikeNetwork201204.shp")
# Convert all to same projected CRS
schools <- st_transform(schools, 2272)
crime <- st_transform(crime, 2272)
bike_network <- st_transform(bike_network, 2272)
st_crs(schools)
st_crs(crime)
st_crs(bike_network)
nrow(schools); nrow(crime); nrow(bike_network)
# Create 500 ft buffers around schools
school_buffer <- st_buffer(schools, dist = 500)
# Create 300 ft buffers around bike lanes
bike_buffer <- st_buffer(bike_network, dist = 300)
# Quick visualization
# 1. Buffer
school_buffer <- st_buffer(schools, dist = 500)
bike_buffer <- st_buffer(bike_network, dist = 300)
# 2. Spatial join: count crimes in each school buffer
crime_in_school <- st_join(crime, school_buffer, join = st_within)
crime_summary <- crime_in_school %>%
st_drop_geometry() %>%
group_by(school_name) %>%
summarise(crime_count = n())
# 3. Identify whether each school has nearby bike lanes
school_bike_join <- school_buffer %>%
mutate(has_bike = if_else(
rowSums(st_intersects(., bike_buffer, sparse = FALSE)) > 0, 1, 0
))
# 4. Merge crime + bike data
school_analysis <- school_bike_join %>%
left_join(crime_summary, by = "school_name") %>%
mutate(crime_count = replace_na(crime_count, 0),
at_risk = if_else(crime_count > 50 & has_bike == 0, 1, 0))
# 5. Filter and visualize
at_risk_schools <- school_analysis %>% filter(at_risk == 1)
school_analysis_df <- school_analysis %>%
st_drop_geometry()
# Summary
summary_table <- school_analysis_df %>%
summarise(
total_schools = n(),
total_at_risk = sum(at_risk, na.rm = TRUE),
avg_crime_near_school = round(mean(crime_count, na.rm = TRUE), 1)
) %>%
rename(
"Total Schools" = total_schools,
"At-Risk Schools" = total_at_risk,
"Average Crimes Near Schools" = avg_crime_near_school
)
summary_table %>%
kbl(
caption = "Table 1. Summary Statistics of School Safety and Bicycle Infrastructure in Philadelphia",
align = c('c', 'c', 'c'),
booktabs = TRUE
) %>%
kable_styling(
full_width = FALSE,
bootstrap_options = c("striped", "hover", "condensed", "responsive")
)
# Drop geometry and clean data
at_risk_table <- at_risk_schools %>%
st_drop_geometry() %>%
filter(!is.na(school_name_label)) %>%
select(
`School Name` = school_name_label,
`Crime Incidents` = crime_count,
`Nearby Bike Lane` = has_bike
) %>%
mutate(
`Crime Incidents` = formatC(`Crime Incidents`, format = "d", big.mark = ","),
`Nearby Bike Lane` = if_else(`Nearby Bike Lane` == 1, "Yes", "No")
) %>%
arrange(desc(as.numeric(`Crime Incidents`))) %>%
slice_head(n = 10)
# Output table
at_risk_table %>%
kbl(
caption = "Table 2. Top 10 At-Risk Schools in Philadelphia: High Crime and No Nearby Bicycle Infrastructure",
align = c("l", "c", "c"),
booktabs = TRUE
) %>%
kable_styling(
full_width = FALSE,
bootstrap_options = c("striped", "hover", "condensed", "responsive")
) %>%
column_spec(1, bold = TRUE, width = "5cm") %>%
column_spec(2:3, width = "3cm") %>%
add_header_above(c(" " = 1, "Safety Risk Indicators" = 2))
# Create 500 ft buffers around schools
school_buffer <- st_buffer(schools, dist = 500)
# Create 300 ft buffers around bike lanes
bike_buffer <- st_buffer(bike_network, dist = 300)
# Quick visualization
# Static visualization
library(tmap)
tmap_mode("plot")
tm_shape(bike_buffer) +
tm_borders(col = "steelblue", lwd = 1) +
tm_shape(school_buffer) +
tm_borders(col = "red", lwd = 1) +
tm_shape(crime) +
tm_dots(col = "black", size = 0.02) +
tm_layout(
title = "School and Bike Lane Buffers with Crime Points",
frame = FALSE,
legend.outside = TRUE
)
# 1. Buffer
school_buffer <- st_buffer(schools, dist = 500)
bike_buffer <- st_buffer(bike_network, dist = 300)
# 2. Spatial join: count crimes in each school buffer
crime_in_school <- st_join(crime, school_buffer, join = st_within)
crime_summary <- crime_in_school %>%
st_drop_geometry() %>%
group_by(school_name) %>%
summarise(crime_count = n())
# 3. Identify whether each school has nearby bike lanes
school_bike_join <- school_buffer %>%
mutate(has_bike = if_else(
rowSums(st_intersects(., bike_buffer, sparse = FALSE)) > 0, 1, 0
))
# 4. Merge crime + bike data
school_analysis <- school_bike_join %>%
left_join(crime_summary, by = "school_name") %>%
mutate(crime_count = replace_na(crime_count, 0),
at_risk = if_else(crime_count > 50 & has_bike == 0, 1, 0))
# 5. Filter and visualize
library(tmap)
tmap_mode("plot")  # ✅ 静态输出模式
tm_shape(bike_network) +
tm_lines(col = "steelblue", lwd = 1) +
tm_shape(school_buffer) +
tm_borders(col = "firebrick", lwd = 1) +
tm_shape(at_risk_schools) +
tm_dots(col = "black", size = 0.3) +
tm_layout(
title = "At-Risk Schools: High Crime and No Nearby Bike Lanes",
legend.outside = TRUE,
frame = FALSE
)
# 1. Buffer
school_buffer <- st_buffer(schools, dist = 500)
bike_buffer <- st_buffer(bike_network, dist = 300)
# 2. Spatial join: count crimes in each school buffer
crime_in_school <- st_join(crime, school_buffer, join = st_within)
crime_summary <- crime_in_school %>%
st_drop_geometry() %>%
group_by(school_name) %>%
summarise(crime_count = n())
# 3. Identify whether each school has nearby bike lanes
school_bike_join <- school_buffer %>%
mutate(has_bike = if_else(
rowSums(st_intersects(., bike_buffer, sparse = FALSE)) > 0, 1, 0
))
# 4. Merge crime + bike data
school_analysis <- school_bike_join %>%
left_join(crime_summary, by = "school_name") %>%
mutate(crime_count = replace_na(crime_count, 0),
at_risk = if_else(crime_count > 50 & has_bike == 0, 1, 0))
# 5. Filter and visualize
at_risk_schools <- school_analysis %>%
filter(at_risk == 1)
# Optional: check how many schools
nrow(at_risk_schools)
library(tmap)
tmap_mode("plot")  # ✅ 静态输出模式
tm_shape(bike_network) +
tm_lines(col = "steelblue", lwd = 1) +
tm_shape(school_buffer) +
tm_borders(col = "firebrick", lwd = 1) +
tm_shape(at_risk_schools) +
tm_dots(col = "black", size = 0.3) +
tm_layout(
title = "At-Risk Schools: High Crime and No Nearby Bike Lanes",
legend.outside = TRUE,
frame = FALSE
)
View(crime_coords)
View(crime)
