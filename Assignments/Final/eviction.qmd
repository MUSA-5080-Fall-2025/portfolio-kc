---
title: "Philadelphia Eviction Prediction"
author: "Your Name"
date: "`r format(Sys.Date(), '%Y-%m-%d')`"
format:
  html:
    toc: true
    toc-depth: 3
    number-sections: true
execute:
  echo: true
  warning: true
  message: true
editor: visual
---

```{r setup, include=FALSE}
library(tidycensus)
library(sf)
library(dplyr)
library(readr)
library(RSocrata)
library(zoo)
library(lubridate)
library(ggplot2)

options(scipen = 999, dplyr.summarise.inform = FALSE)
```

# 1. Research Question and Overview

## 1.1 Core Research Question

**Can we predict eviction filing counts at the census-tract level 1–3 months in advance, enabling the City of Philadelphia to proactively deploy rental assistance, legal aid resources, and community outreach?**

-   **Spatial Unit:** Census tract\
-   **Temporal Unit:** Monthly (or quarterly)\
-   **Outcome:** Number of eviction filings in next 1–3 months\
-   **Model:** Poisson / Negative Binomial (count outcome), or logistic if binarized

------------------------------------------------------------------------

# 2. Workflow Overview

This QMD outlines a reproducible workflow to assemble a tract-month dataset for predictive modeling:

1.  Download Census tract boundaries\
2.  Collect ACS socioeconomic & housing indicators\
3.  Collect and aggregate OPA property assessment data\
4.  Construct spatial features (distance to courts, transit access, optional crime data)\
5.  Process eviction records into tract-month format\
6.  Create lagged eviction variables\
7.  Merge into a master modeling dataset

------------------------------------------------------------------------

# 3. Step 1: Census Tract Boundaries (Spatial Base)

```{r census-tracts}
philly_tracts <- get_acs(
  geography = "tract",
  state = "PA",
  county = "Philadelphia",
  variables = "B01001_001",
  year = 2022,
  geometry = TRUE
)

philly_tracts_sf <- philly_tracts %>% select(GEOID, geometry)
philly_tracts_sf
```

------------------------------------------------------------------------

# 4. Step 2: ACS Data (Socioeconomic & Housing Indicators)

## 4.1 Define ACS Variables

```{r acs-data}
acs_vars <- c(
  total_pop          = "B01001_001",
  white_pop          = "B02001_002",
  black_pop          = "B02001_003",
  asian_pop          = "B02001_005",
  hispanic_pop       = "B03003_003",
  median_income      = "B19013_001",
  poverty_total      = "B17001_001",
  poverty_below      = "B17001_002",
  unemployment_total = "B23025_002",
  unemployment_unemployed = "B23025_005",
  total_housing_units = "B25001_001",
  renter_occupied     = "B25003_003",
  median_rent         = "B25064_001",
  median_home_value   = "B25077_001",
  rent_30_to_35_pct   = "B25070_007",
  rent_35_to_40_pct   = "B25070_008",
  rent_40_to_50_pct   = "B25070_009",
  rent_50_plus_pct    = "B25070_010",
  median_year_built   = "B25037_001",
  vacant_units        = "B25002_003"
)

acs_raw <- get_acs(
  geography = "tract",
  state = "PA",
  county = "Philadelphia",
  variables = acs_vars,
  year = 2022,
  output = "wide",
  geometry = FALSE
)

acs_final <- acs_raw %>%
  mutate(
    pct_white = white_popE / total_popE * 100,
    pct_black = black_popE / total_popE * 100,
    pct_hispanic = hispanic_popE / total_popE * 100,
    pct_asian = asian_popE / total_popE * 100,
    poverty_rate = poverty_belowE / poverty_totalE * 100,
    unemployment_rate = unemployment_unemployedE / unemployment_totalE * 100,
    pct_renter = renter_occupiedE / total_housing_unitsE * 100,
    rent_burdened = rent_30_to_35_pctE + rent_35_to_40_pctE +
                    rent_40_to_50_pctE + rent_50_plus_pctE,
    pct_rent_burdened = rent_burdened / renter_occupiedE * 100,
    pct_severe_burden = rent_50_plus_pctE / renter_occupiedE * 100,
    property_age = 2024 - median_year_builtE
  ) %>%
  select(
    GEOID,
    total_popE,
    pct_white, pct_black, pct_hispanic, pct_asian,
    poverty_rate, unemployment_rate,
    median_incomeE, pct_renter,
    pct_rent_burdened, pct_severe_burden,
    median_rentE, median_home_valueE,
    property_age, vacant_unitsE
  ) %>%
  rename(
    total_pop = total_popE,
    median_income = median_incomeE,
    median_rent = median_rentE,
    median_home_value = median_home_valueE,
    vacant_units = vacant_unitsE
  )

acs_final
```

------------------------------------------------------------------------

# 5. Step 3: OPA Property Assessment Data

```{r opa, eval=FALSE}
opa_url <- "https://phl.carto.com/api/v2/sql?q=SELECT * FROM opa_properties_public"
opa_raw <- read.socrata(opa_url)

property_summary <- opa_raw %>%
  filter(!is.na(census_tract)) %>%
  group_by(census_tract) %>%
  summarise(
    n_properties = n(),
    avg_market_value = mean(market_value, na.rm = TRUE),
    median_market_value = median(market_value, na.rm = TRUE),
    pct_residential = mean(category_code_description == "Residential", na.rm = TRUE) * 100
  ) %>%
  rename(GEOID = census_tract)

property_summary
```

------------------------------------------------------------------------

# 6. Step 4: Spatial Features

## 6.1 Distance to Courts

```{r courts}
courts <- tibble::tribble(
  ~name, ~lat, ~lon,
  "Municipal Court", 39.9496, -75.1617,
  "Civil Court",     39.9526, -75.1652
)

courts_sf <- st_as_sf(courts, coords = c("lon", "lat"), crs = 4326)
tracts_proj <- st_transform(philly_tracts_sf, 26918)
courts_proj <- st_transform(courts_sf, 26918)

centroids <- st_centroid(tracts_proj)
dist_matrix <- st_distance(centroids, courts_proj)
centroids$dist_to_court_km <- apply(dist_matrix, 1, min) / 1000

dist_to_court <- centroids %>%
  st_drop_geometry() %>%
  select(GEOID, dist_to_court_km)

dist_to_court
```

------------------------------------------------------------------------

# 7. Step 5: Eviction Lag Variables

```{r eviction-lags, eval=FALSE}
evictions_with_lags <- evictions_monthly %>%
  arrange(GEOID, year_month) %>%
  group_by(GEOID) %>%
  mutate(
    lag1 = lag(eviction_filings, 1),
    lag3 = lag(eviction_filings, 3),
    lag6 = lag(eviction_filings, 6),
    lag12 = lag(eviction_filings, 12),
    avg3 = rollmean(eviction_filings, k = 3, fill = NA, align = "right"),
    avg6 = rollmean(eviction_filings, k = 6, fill = NA, align = "right")
  ) %>%
  ungroup()

evictions_with_lags
```

------------------------------------------------------------------------

# 8. Step 6: Merge All Data

```{r merge}
modeling_data <- evictions_with_lags %>%
  left_join(acs_final, by = "GEOID") %>%
  left_join(property_summary, by = "GEOID") %>%
  left_join(dist_to_court, by = "GEOID")

modeling_data
```

------------------------------------------------------------------------

# 9. Next Steps for Modeling

-   Conduct EDA (mapping, time trends, correlations)\
-   Fit Poisson or Negative Binomial regression\
-   Use 2020–2023 as training; 2024 as test\
-   Compare against baseline (previous month’s filings)

------------------------------------------------------------------------
